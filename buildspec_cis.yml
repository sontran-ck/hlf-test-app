version: 0.2
env:
  variables:
     AWS_DEFAULT_REGION: "<REDACTED>"
     EKS_CLUSTER_NAME: "<REDACTED>"

phases:
  build:
    commands:
      - |
        if [ "$X_ENABLE" = "true" ]; then
          echo "X is enabled, start syncing image..."
          curl -o aws-iam-authenticator https://s3.us-west-2.amazonaws.com/amazon-eks/1.21.2/2021-07-05/bin/linux/amd64/aws-iam-authenticator
          chmod +x ./aws-iam-authenticator
          mkdir -p $HOME/bin && cp ./aws-iam-authenticator $HOME/bin/aws-iam-authenticator && export PATH=$PATH:$HOME/bin
          curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.21.0/bin/linux/amd64/kubectl
          chmod +x kubectl
          mv ./kubectl /usr/local/bin/kubectl
          curl -sSL https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash

          helm version
          git --version
          aws eks update-kubeconfig --region <REDACTED> --name <REDACTED>
          git clone https://<REDACTED>@github.com/<REDACTED>/<REDACTED>.git /tmp/deployment/<REDACTED>
          cd /tmp/deployment/<REDACTED>/
          ls -alht
          kubectl get nodes
          helm upgrade --install container-image-sync charts/container-image-sync -n <REDACTED> \
            -f envs/<REDACTED>/release-definition.yaml \
            -f envs/<REDACTED>/imageSync.yaml \
            -f envs/config/cis_conf.yaml \
            --wait --timeout 5m || true
          kubectl get pod -n <REDACTED>
        else
          echo "CIS is disabled. Skipping image sync."
        fi
      - echo "Container Image Sync step finished."

  post_build:
    commands:
       - echo -e "\nContainer Image Sync helm chart has been deployed without error"